# ECOTRACE ML Pipeline — Setup Guide

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                    ECOTRACE ML PIPELINE                         │
│                                                                 │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────────┐   │
│  │ fetchTraining │───▶│ featureEncoder│───▶│   trainModel.js  │   │
│  │  Data.js      │    │    .ts        │    │  (TF.js Node)    │   │
│  │              │    │              │    │                  │   │
│  │ Scrapes OFF  │    │ 12-feature   │    │ 12→32→16→1 NN   │   │
│  │ API (5000+)  │    │ encoding     │    │ Adam + MSE       │   │
│  └──────────────┘    └──────────────┘    └────────┬─────────┘   │
│                                                   │             │
│                                          weights.json           │
│                                                   │             │
│  ┌──────────────┐    ┌──────────────┐    ┌────────▼─────────┐   │
│  │ ScannerScreen│───▶│ openFoodFacts│───▶│  mlPrediction.ts │   │
│  │   .tsx       │    │    .ts       │    │                  │   │
│  │             │    │             │    │ Neural Network    │   │
│  │ Barcode scan│    │ API lookup  │    │ → Rule-based     │   │
│  │ Camera UI   │    │ Data quality│    │ → Category avg   │   │
│  └──────────────┘    └──────────────┘    └────────┬─────────┘   │
│                                                   │             │
│                                          ┌────────▼─────────┐   │
│                                          │ tensorflowModel  │   │
│                                          │    .ts           │   │
│                                          │                  │   │
│                                          │ Pure TypeScript  │   │
│                                          │ Neural Network   │   │
│                                          │ (Hermes-safe)    │   │
│                                          └──────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## Quick Start

### 1. Install Dependencies

```bash
npm install
```

### 2. Run the ML Training Pipeline

```bash
# Full pipeline: fetch data → train model
npm run ml-pipeline

# Or run steps individually:
npm run fetch-training-data   # Scrape 5000+ products from Open Food Facts
npm run train-model           # Train the neural network
```

### 3. Start the App

```powershell
# If you have network issues with Expo:
$env:EXPO_OFFLINE="1"; npx expo start --lan

# Standard:
npm start
```

## File Reference

### Training Pipeline (Node.js — runs on your machine)

| File | Purpose |
|------|---------|
| `scripts/fetchTrainingData.js` | ETL pipeline: paginates OFF API, collects 5000+ products with ecoscore data |
| `scripts/trainModel.js` | Trains TF.js model (12→32→16→1), saves weights as JSON |
| `data/realTrainingData.json` | Raw scraped products (generated by fetchTrainingData) |
| `assets/ml/eco-score-model/weights.json` | Trained NN weights (generated by trainModel) |
| `assets/ml/modelMetadata.json` | Training stats, accuracy metrics, architecture info |

### App Runtime (React Native — runs on device)

| File | Purpose |
|------|---------|
| `services/tensorflowModel.ts` | Pure TypeScript neural network — **no native deps** |
| `services/featureEncoder.ts` | Converts raw product data → 12-feature vector |
| `services/mlPrediction.ts` | Prediction service with 3-tier fallback chain |
| `services/openFoodFacts.ts` | Open Food Facts API client |
| `services/scoring.ts` | 5-factor sustainability scoring |
| `screens/ScannerScreen.tsx` | Camera barcode scanner UI |

## Neural Network Architecture

```
Input Layer:  12 features (normalized 0-1)
Hidden 1:     32 neurons, ReLU activation
Hidden 2:     16 neurons, ReLU activation
Output:       1 neuron, Sigmoid activation (eco-score 0-1)

Total Parameters: 961
Optimizer: Adam (lr=0.001, β₁=0.9, β₂=0.999)
Loss: Mean Squared Error (MSE)
```

### The 12 Input Features

| # | Feature | Range | Source |
|---|---------|-------|--------|
| 0 | categoryScore | 0-1 | Category tag mapping (e.g., organic=0.9, meat=0.2) |
| 1 | novaGroupScore | 0-1 | NOVA food processing level (1=1.0, 4=0.1) |
| 2 | hasOrganicLabel | 0/1 | Organic certification detected |
| 3 | hasFairTradeLabel | 0/1 | Fair trade certification detected |
| 4 | hasSustainabilityCert | 0/1 | Rainforest Alliance, FSC, MSC, etc. |
| 5 | packagingScore | 0-1 | Material sustainability (glass=0.9, plastic=0.2) |
| 6 | originScore | 0-1 | Geographic proximity (local=1.0, imported=0.4) |
| 7 | manufacturingScore | 0-1 | Manufacturing location sustainability |
| 8 | labelCount | 0-1 | Total certification labels (normalized) |
| 9 | categoryCount | 0-1 | Category richness (normalized) |
| 10 | isVegan | 0/1 | Product is vegan |
| 11 | isVegetarian | 0/1 | Product is vegetarian |

## Prediction Fallback Chain

1. **Neural Network** (best) — Uses trained weights if available. Confidence based on output decisiveness.
2. **Rule-Based** — Weighted feature sum when NN is untrained but ≥3 features available.
3. **Category Average** — Last resort when data is insufficient.

## Why Pure TypeScript Instead of TF.js?

`@tensorflow/tfjs` crashes in React Native's Hermes engine because it depends on Node.js
`util.isTypedArray` which doesn't exist in Hermes. Our solution:

- **Training** (Node.js): Uses `@tensorflow/tfjs` — works perfectly since Node has `util`
- **Inference** (React Native): Uses hand-coded TypeScript matrix math — zero native deps

The pure-TS neural network implements the same mathematics:
- Glorot/Xavier weight initialization
- Matrix multiplication (matMulVec)
- ReLU and Sigmoid activations
- Backpropagation with gradient computation
- Adam optimizer with bias correction

## Training Custom Models

```bash
# Fetch more data with custom options
node scripts/fetchTrainingData.js

# Train with custom hyperparameters
node scripts/trainModel.js --epochs 200 --lr 0.0005 --batch 64
```

The trained weights are saved to `assets/ml/eco-score-model/weights.json` and
automatically bundled with the app via `require()`.

## Accuracy Metrics

After training, the pipeline outputs:
- **MSE** — Mean Squared Error
- **RMSE** — Root Mean Squared Error  
- **MAE** — Mean Absolute Error
- **R²** — Coefficient of determination
- **Tolerance accuracy** — % predictions within ±5, ±10, ±15, ±20 points
